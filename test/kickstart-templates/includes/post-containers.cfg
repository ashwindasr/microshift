# The pull secret is mandatory for MicroShift builds on top of OpenShift, but not OKD
# The /etc/crio/crio.conf.d/microshift.conf references the /etc/crio/openshift-pull-secret file
mkdir -p /etc/crio
cat > /etc/crio/openshift-pull-secret <<EOF
REPLACE_PULL_SECRET
EOF
chmod 600 /etc/crio/openshift-pull-secret

# Setup mirror registries configuration here, as the hostname is dynamic and the file is verbose.
# Use hostnames as IP addresses are not allowed.
mkdir -p /etc/containers/registries.conf.d
cat > /etc/containers/registries.conf.d/999-microshift-mirror.conf <<EOF
[[registry]]
    prefix = ""
    location = "REPLACE_MIRROR_HOSTNAME:REPLACE_MIRROR_PORT"
    mirror-by-digest-only = true
    insecure = true

[[registry]]
    prefix = ""
    location = "quay.io"
    mirror-by-digest-only = true
[[registry.mirror]]
    location = "REPLACE_MIRROR_HOSTNAME:REPLACE_MIRROR_PORT/microshift"
    insecure = true

[[registry]]
    prefix = ""
    location = "registry.redhat.io"
    mirror-by-digest-only = true
[[registry.mirror]]
    location = "REPLACE_MIRROR_HOSTNAME:REPLACE_MIRROR_PORT/microshift"
    insecure = true
EOF

# Download the Red Hat public key published at https://access.redhat.com/security/team/key.
# Currently release key 3 is used.
curl -L https://access.redhat.com/security/data/63405576.txt > /etc/containers/RedHat_ReleaseKey3.pub

# Configure containers policy to use the Red Hat public key
if [ -f /etc/containers/policy.json ] ; then
    mv /etc/containers/policy.json /etc/containers/policy.json.orig
fi
cat > /etc/containers/policy.json <<EOF
{
    "default": [
        {
            "type": "reject"
        }
    ],
    "transports": {
        "docker": {
            "quay.io/openshift-release-dev": [{
                "type": "sigstoreSigned",
                "keyPath": "/etc/containers/RedHat_ReleaseKey3.pub",
                "signedIdentity": {
                    "type": "matchRepoDigestOrExact"
                }
            }],
            "registry.redhat.io": [{
                "type": "sigstoreSigned",
                "keyPath": "/etc/containers/RedHat_ReleaseKey3.pub",
                "signedIdentity": {
                    "type": "matchRepoDigestOrExact"
                }
            }]
        }
    }
}
EOF

# Configure the MicroShift registries to use sigstore attachments
cat > /etc/containers/registries.d/registry.quay.io.yaml <<EOF
docker:
    quay.io/openshift-release-dev:
        use-sigstore-attachments: true
EOF

# Add the mirror registry host name resolution
cat >> /etc/hosts <<EOF
REPLACE_VM_BRIDGE_IP REPLACE_MIRROR_HOSTNAME
EOF
